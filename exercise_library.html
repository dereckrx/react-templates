<!DOCTYPE HTML>
<head>
  <title>ReactRx Title</title>
  <link rel="stylesheet" href="app.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.0/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.0/react-dom.js"></script>
</head>
<body>

<div id="app"/>

<script defer type="module">
  import {SimplyReact, SimplyReactDOM} from './simply_react.js';
  import {Store} from './reduxrx/store.js';

  const {o} = SimplyReactDOM(ReactDOM);
  const {x, div, h1, h2, input} = SimplyReact(React.createElement);

  const Item = (props) => {
    const handleRemove = () => actions.removeItem(props);
    const handleView = () => actions.viewItem(props);
    return (
      div({className: 'item'},
        input({type: 'checkbox', onClick: handleRemove}),
        x('label', {onClick: handleView}, props.name)
      )
    );
  };

  const ItemForm = (props) => {
    const handleKeyPress = (e) => {
      if (e.key === 'Enter') {
        actions.addItem({name: e.target.value});
        e.target.value = '';
      }
    };

    return (
      div({className: 'item'},
        input({
          id: 'new-item-input',
          type: 'text', placeholder: 'new item', onKeyPress: handleKeyPress
        })
      )
    );
  };

  const ItemList = (props) => {
    const itemComponents = props.items.map((item) => x(Item, {...item, key: item.id}));
    return (
      div({style: {display: 'flex', flexDirection: 'column', justifyContent: 'flex-start'}},
        itemComponents
      )
    )
  };

  const Sidebar = (props) => {
    return (
      div({className: 'sidebar'},
        div({className: 'app-box', style: {display: 'flex', flexDirection: 'column'}},
          h2('Items'),
          x(ItemForm, {}),
          x(ItemList, props)
        )
      )
    )
  };

  const MainView = (props) => {
    const item = props.state.selectedItem;
    return (
      div({className: 'detail-view'},
        h2('Item Detail'),
        div({className: 'item'},
          item.name,
          div({style: {height: '100px'}},
            x('img', {style: {height: '100%'}, src: item.imageUrl})
          ),
          x('iframe', {width: "392", height: "220", src: item.videoUrl, frameBorder: "0"})
        )
      )
    )
  };

  const InputView = (props) => {
    const input = x('input', {value: props.state.inputValue});
    const buttons = [0,1,2,3,4,5,6,7,8,9].map((num) => {
      return x('button', {
          onClick: (e) => {
          console.log(e.target.value);
          actions.updateInput(e.target.value);
        },
        value: num,
        },

        `${num}`);
    });
    return (
      div({style: {width: "100px"}},
        input,
        div({},
          ...buttons
        )
      )
    )
  };

  const RepTimer = (props) => {
    const synth = window.speechSynthesis;
    const utterThis = new SpeechSynthesisUtterance(value);
    utterThis.voice = synth.getVoices()[48];

    let interval = null;
    const repCount = props.state.count;
    const createInterval = (countLength, cb) => {
      return setInterval(() => cb(), countLength * 1000);
    };

    const speak = (value) => {

      synth.speak(utterThis);
    };

    const stopButton = x('button', {onClick: (e) => {
        clearInterval(interval);
      }},
      'Stop'
    );

    const buttons = [2,3,5].map((num) => {
      return x('button', {
          onClick: (e) => {
            interval = createInterval(num, () => {
              actions.incrementCount();
            });
          },
          value: num,
        },

        `${num}`);
    });

    if(repCount === 1) {
      speak('Go!');
    }else if(repCount !== 0 && repCount % 5 === 0) {
      speak(`${repCount}`);
    }

    return (
      div({style: {width: "100px"}},
        "Count: " + repCount,
        stopButton,
        div({},
          ...buttons
        )
      )
    )
  };

  // -------------------------------------------------
  const reducer = (action, state) => {
    switch (action.type) {
      case 'ADD_ITEM':
        return {
          ...state,
          items: [...state.items, action.props],
          maxItemId: action.props.id
        };
      case 'REMOVE_ITEM':
        return {...state, items: state.items.filter((item) => item.id !== action.id)};
      case 'VIEW_ITEM':
        return {...state, selectedItem: action.item};
      case 'UPDATE_INPUT':
        return {...state, inputValue: state.inputValue + action.value};
      case 'INCREMENT_COUNT':
        return {...state, count: state.count + 1 };
      default:
        return state;
    }
  };

  const Actions = ({reducer, initialState}) => {
    const store = Store({reducer, state: initialState});

    const init = () => {
      store.dispatch({});
    };
    const addItem = (props) => {
      const action = {type: 'ADD_ITEM', props};
      action.props.id = store.getState().maxItemId + 1;
      store.dispatch(action);
    };
    const removeItem = (props) => {
      const action = {type: 'REMOVE_ITEM', ...props};
      store.dispatch(action);
    };
    const viewItem = (item) => {
      const action = {type: 'VIEW_ITEM', item};
      store.dispatch(action);
    };
    const updateInput = (value) => {
      const action = {type: 'UPDATE_INPUT', value};
      store.dispatch(action)
    };
    const incrementCount = () => {
      const action = {type: 'INCREMENT_COUNT'};
      store.dispatch(action)
    };
    return {
      subscribe: store.subscribe,
      init,
      addItem,
      removeItem,
      viewItem,
      updateInput,
      incrementCount,
    }
  };

  const items = [
    {
      id: 1,
      name: 'Scapular Pushup',
      imageUrl: 'https://jscfitness.com/wp-content/uploads/2015/04/ktszs.gif',
      videoUrl: 'https://www.youtube.com/embed/VCPp1DUypo0'
    },
    {id: 2, name: 'second'}
  ];
  const initialState = {
    selectedItem: items[0],
    maxItemId: items.length,
    items: items,
    inputValue: 0,
    count: 0,
  };
  const actions = Actions({reducer, initialState});

  actions.subscribe((state) => {
    o('app',
      x('div', {className: 'app-content'},
        x('div', {style: {display: 'flex', justifyContent: 'center'}},
          x(RepTimer, {state})
        ),
        x('div', {style: {display: 'flex', justifyContent: 'center'}},
          x(Sidebar, {items: state.items}),
          x(MainView, {state}),
          x(InputView, {state}),
        )
      )
    );
  });
  actions.init();

</script>
</body>
</html>