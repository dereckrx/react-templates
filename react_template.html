<!DOCTYPE HTML>
<head>
  <title>ReactRx Title</title>
</head>
<body>

<div id="app"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.0/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.0/react-dom.js"></script>

<script type="module">
  import {SimplyReact, SimplyReactDOM} from './simply_react.js';

  const {o} = SimplyReactDOM(ReactDOM);
  const {x, div, h1, h2, input} = SimplyReact(React.createElement);

  const Item = (props) => {
    const handleRemove = () => store.removeItem(props);
    return (
      div({style: {marginBottom: '16px'}},
        input({type: 'checkbox', onClick: handleRemove}),
        props.name
      )
    );
  };

  const ItemForm = (props) => {
    const handleKeyPress = (e) => {
      if (e.key === 'Enter') {
        store.addItem({name: e.target.value});
      }
    };

    return (
      div({style: {}},
        h2('New Item'),
        input({
          type: 'text', placeholder: 'name', onKeyPress: handleKeyPress
        }),
      )
    );
  };

  const ItemList = (props) => {
    const itemComponents = props.items.map((item) => x(Item, {...item, key: item.id}));
    return (
      div(
        h1('Items'),
        div({style: {display: 'flex', flexDirection: 'column', justifyContent: 'flex-start'}},
          itemComponents
        )
      )
    )
  };

  const Sidebar = (props) => {
    return (
      x('div', {style: {display: 'flex', flexDirection: 'column'}},
        x(ItemForm, {}),
        x(ItemList, props)))
  };

  const MainView = (props) => {
    return (
      div()
    )
  };

  const reducer = (action, state) => {
    const merge = (object, values) => {
      return {...object, ...values}
    };

    switch (action.type) {
      case 'ADD_ITEM':
        return merge(state, {
            items: [...state.items, action.props],
            maxItemId: action.props.id
          }
        );
      case 'REMOVE_ITEM':
        return {...state, items: state.items.filter((item) => item.id !== action.id)};
      default:
        return state;
    }
  };

  const Store = ({reducer, initialState}) => {
    let state = initialState;
    const subscribers = [];

    const dispatch = (action) => {
      state = reducer(action, state);
      subscribers.forEach((notify) => notify(state))
      console.log('++> ', state)
    };
    const subscribe = (notify) => {
      subscribers.push(notify)
    };
    const addItem = (props) => {
      const action = {type: 'ADD_ITEM', props};
      action.props.id = state.maxItemId + 1;
      dispatch(action);
    };
    const removeItem = (props) => {
      const action = {type: 'REMOVE_ITEM', ...props};
      dispatch(action);
    };
    return {
      dispatch,
      subscribe,
      addItem,
      removeItem
    }
  };

  const items = [
    {id: 1, name: 'first'},
    {id: 2, name: 'second'}
  ];
  const initialState = {
    maxItemId: items.length,
    items: items
  };
  const store = Store({reducer, initialState});

  store.subscribe((state) => {
    o('app',
      x('div', {style: {display: 'flex', justifyContent: 'center', width: '100%', height: '100%'}},
        x('div', {style: {marginTop: '50px'}},
          x(Sidebar, {items: state.items}),
          x(MainView, {state})
        )
      )
    );
  });
  store.dispatch({})

</script>
</body>
</html>